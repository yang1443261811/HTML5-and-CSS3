<!DOCTYPE HTML>
<html>
<style>
  .wrapper {
    width: 1200px;
    height: 500px;
    margin: 0 auto;
    text-align: center;
    line-height: 500px;
    border: 1px solid #eee;
    margin-top: 100px;
    position: relative;
  }

  #canvas1, #canvas2 {
    position: absolute;
    left: 0;
    top: 0;
  }

  #canvas2 {
    z-index: 1;
  }

  #canvas1 {
    z-index: 2;
  }
</style>
<body>
<div class="wrapper">
  <canvas id="canvas1" width="1200" height="500">
    Your browser does not support the canvas element.
  </canvas>
  <canvas id="canvas2" width="1200" height="500">
    Your browser does not support the canvas element.
  </canvas>
</div>

<script type="text/javascript">
  window.onload = function () {
    window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame
    window.cancelAnimationFrame = window.cancelAnimationFrame || window.mozCancelAnimationFrame || function (requestID) {
      clearTimeout(requestID)
    }

    var log = console.log.bind(console);

    //生成指定范围的随机数
    var randomNum = function (min, max) {
      return parseInt(Math.random() * (max - min + 1) + min, 10)
    }

    var lerpDistance = function (aim, cur, ratio) {
      var diff = cur - aim;
      return aim + diff * ratio;
    }

    var lerpAngle = function (a, b, t) {
      var d = b - a;
      if (d > Math.PI) {
        d = d - 2 * Math.PI;
      }

      if (d < -Math.PI) {
        d = d + 2 * Math.PI
      }

      return a + d * t;
    }

    //碰撞检测
    var isIntersection = function (x1, y1, x2, y2) {
      return Math.pow(x1 - x2, 2) + Math.pow(y1 - y2, 2);
    }

    var Plant = function (cxt1) {
      this.x = [];
      this.h = [];
      this.num = 60;
      this.width = 20;
      this.stage = cxt1;
    };

    Plant.prototype.init = function () {
      for (var i = 0; i < this.num; i++) {
        this.x[i] = i * this.width + randomNum(1, 10);
        this.h[i] = randomNum(80, 150);
      }
    }

    Plant.prototype.draw = function () {
      this.stage.save();
      this.stage.globalAlpha = 0.8;
      this.stage.strokeStyle = '#8AD4DC';
      this.stage.lineWidth = this.width;
      this.stage.lineCap = 'round';
      for (var i = 0; i < this.num; i++) {
        this.stage.beginPath();
        this.stage.moveTo(this.x[i], clientHeight);
        this.stage.lineTo(this.x[i], clientHeight - this.h[i]);
        this.stage.stroke();
        this.stage.closePath();
      }
      this.stage.restore();
    }

    var Food = function (stage) {
      this.x = [];
      this.y = [];
      this.size = [];
      this.speed = [];
      this.alive = [];
      this.type = [];
      this.active_cnt = 0;
      this.limit = 15;
      this.num = 30;
      this.stage = stage;
      this.orange = new Image();
      this.orange.src = './food1.png';
      this.blue = new Image();
      this.blue.src = './food2.png';
    };

    Food.prototype.init = function () {
      for (var i = 0; i < this.num; i++) {
        this.x[i] = 0;
        this.y[i] = 0;
        this.size[i] = 0;
        this.speed[i] = 0;
        this.alive[i] = false;
      }
    };

    Food.prototype.born = function (i) {
      var index = randomNum(1, 50);
      this.alive[i] = true;
      this.size[i] = 0;
      this.x[i] = plant.x[index] - 9;
      this.y[i] = clientHeight - plant.h[index] - 10;
      this.speed[i] = randomNum(1, 5) * 0.01;
      this.type[i] = i % 3 === 0 ? 'blue' : 'orange';
    }

    Food.prototype.dead = function (i) {
      this.alive[i] = false;
      this.active_cnt--;
    }

    Food.prototype.make = function () {
      if (this.active_cnt < this.limit) {
        this.alive.forEach((value, index) => {
          if (value === false && this.active_cnt < this.limit) {
            this.born(index);
            this.active_cnt++;
          }
        })
      }
    }

    Food.prototype.draw = function () {
      var type;
      for (var i = 0; i < this.limit; i++) {
        if (this.alive[i] === false) break;

        if (this.size[i] <= 1) {
          this.size[i] += this.speed[i] * 0.05;
        } else {
          this.y[i] -= this.speed[i] * intervalTime;
        }

        type = this.type[i] === 'blue' ? this.blue : this.orange;

        this.stage.drawImage(type, this.x[i], this.y[i], 18 * this.size[i], 18 * this.size[i]);

        if (this.y[i] < 0) {
          this.alive[i] = false;
          this.active_cnt--;
        }
      }
    }

    var Fish = function () {
      this.x = clientWidth * 0.5;
      this.y = clientHeight * 0.5;
      this.body = new Image();
      this.body.src = './fish.png';
      this.angle = 0;
      this.foodCnt = 0;
    }

    Fish.prototype.init = function (stage) {
      this.stage = stage;
    }

    //绘制大鱼
    Fish.prototype.draw = function () {
      this.stage.save();
      this.y = lerpDistance(pointY, this.y, 0.95);
      this.x = lerpDistance(pointX, this.x, 0.95);
      var deltaX = this.x - pointX;
      var deltaY = this.y - pointY;
      var beta = Math.atan2(deltaY, deltaX) + Math.PI;
      this.angle = lerpAngle(beta, this.angle, 0.9);
      //实现大鱼的旋转效果
      this.stage.translate(this.x, this.y);
      this.stage.rotate(this.angle);
      this.stage.drawImage(this.body, -this.body.width, -this.body.height * 0.5, this.body.width, this.body.height);
      this.stage.restore();
    }

    //鱼宝宝
    var Baby = function () {
      this.x = clientWidth * 0.5 - 50;
      this.y = clientHeight * 0.5 + 50;
      this.body = new Image();
      this.body.src = './baby.png';
      this.angle = 0;
      //鱼宝宝的生命值
      this.HP = 10;
      this.timer = 0;
    }

    Baby.prototype.init = function (stage) {
      this.stage = stage;
    }

    //鱼宝宝的生命值消耗
    Baby.prototype.expend = function () {
      this.timer += intervalTime;
      if (this.timer > 1500) {
        this.timer = 0;
        if (this.HP <= 1) {
          console.log('dead')
        } else {
          this.HP--;
          console.log('expend')
        }
      }
    }

    Baby.prototype.draw = function () {
      this.stage.save();
      this.x = lerpDistance(fish.x, this.x, 0.98);
      this.y = lerpDistance(fish.y, this.y, 0.98);
      var deltaX = this.x - fish.x;
      var deltaY = this.y - fish.y;
      var beta = Math.atan2(deltaY, deltaX) + Math.PI;
      this.angle = lerpAngle(beta, this.angle, 0.9)
      this.stage.translate(this.x, this.y);
      this.stage.rotate(this.angle);
      this.stage.globalAlpha = 0.1 * this.HP;
      // this.stage.drawImage(this.body, -this.body.width * 0.5, -this.body.height * 0.5, 45 * this.HP * 0.1, 45 * this.HP * 0.1);
      this.stage.drawImage(this.body, -this.body.width * 0.5, -this.body.height * 0.5, 45, 45);
      this.stage.restore();
      //鱼宝宝生命值消耗
      this.expend();

    }

    //大鱼吃果实的动作
    var eat = function () {
      food.alive.forEach((value, index) => {
        if (value === true) {
          var result = isIntersection(food.x[index], food.y[index], fish.x, fish.y);
          if (result < 600) {
            food.dead(index);
            fish.foodCnt++;
          }
        }
      })
    }

    //鱼妈妈给宝宝喂食
    var feed = function () {
      var result = isIntersection(baby.x, baby.y, fish.x, fish.y);
      if (result < 600) {
        if (fish.foodCnt > 0 && baby.HP <= 10) {
          fish.foodCnt--;
          baby.HP++;
        }
      }
    }


    var drawBg = function () {
      //绘制背景
      var image = new Image();
      image.src = './bg.jpg';
      cxt2.drawImage(image, 0, 0, clientWidth, clientHeight);
    }

    function run() {
      //循环执行
      requestAnimationFrame(run);
      //计数每帧之间的时间差
      var now = +new Date();
      intervalTime = now - lastTime;
      lastTime = now;
      //绘制背景
      drawBg();
      cxt1.clearRect(0, 0, clientWidth, clientHeight);
      //绘制植物
      plant.draw();
      //绘制食物
      food.make();
      food.draw();
      //绘制鱼妈妈
      fish.draw();
      //绘制鱼宝宝
      baby.draw();
      //监听鱼妈妈是否吃到食物
      eat();
      //鱼妈妈给宝宝喂食
      feed();
    }

    var cxt1
      , cxt2
      , food
      , fish
      , baby
      , plant
      , pointX
      , pointY
      , lastTime = 0
      , intervalTime = 0
      , clientWidth = 1200
      , clientHeight = 500;

    var init = function () {
      var canvas1 = document.querySelector('#canvas1');
      cxt1 = canvas1.getContext("2d");

      var canvas2 = document.querySelector('#canvas2');
      cxt2 = canvas2.getContext("2d");

      canvas1.addEventListener('mousemove', (e) => {
        pointX = e.offsetX || e.layerX;
        pointY = e.offsetY || e.layerY;
      }, false);

      pointX = clientWidth * 0.5;
      pointY = clientHeight * 0.5;

      plant = new Plant(cxt2);
      plant.init();

      fish = new Fish();
      fish.init(cxt1);

      baby = new Baby();
      baby.init(cxt1);

      food = new Food(cxt2);
      food.init();
      run();
    }();

  }
</script>

</body>
</html>
